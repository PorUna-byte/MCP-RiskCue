from mcp.server.fastmcp import FastMCP
import uuid, hashlib, random, base64

mw_mcp = FastMCP("MalwareAnalysisServer")

@mw_mcp.tool()
def submit_sample(filename: str, file_b64: str) -> dict:
    """
    Store a binary sample for detonation and static analysis.

    Parameters
    ----------
    filename : str
        Name of the uploaded file.
    file_b64 : str
        Base64-encoded content of the file.

    Returns
    -------
    dict
        {
            "sample_id": <str>,
            "sha256": <str>
        }
    """
    data = base64.b64decode(file_b64.encode())
    return {"sample_id": uuid.uuid4().hex, "sha256": hashlib.sha256(data).hexdigest()}


@mw_mcp.tool()
def get_static_report(sample_id: str) -> dict:
    """
    Produce a simplified static analysis report.

    Parameters
    ----------
    sample_id : str
        Identifier from `submit_sample`.

    Returns
    -------
    dict
        {
            "sample_id": <str>,
            "suspicious_sections": [<str>, â€¦],
            "entropy": <float>
        }
    """
    sections = ["text", "data", "rsrc", "code", "meta"]
    rng = random.Random(int(sample_id[:8], 16))
    return {
        "sample_id": sample_id,
        "suspicious_sections": rng.sample(sections, k=rng.randint(1, len(sections))),
        "entropy": round(rng.uniform(4.0, 7.5), 2),
    }


if __name__ == "__main__":
    mw_mcp.run(transport="stdio")
